<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Your Cart - Mocha Dreams</title>
    <link rel="stylesheet" th:href="@{/cart.css}">
    <link rel="stylesheet" th:href="@{/main.css}">

</head>

<body>

<!-- Header from Home Page -->
<header class="site-header">
    <div class="brand-container">
        <div class="brand">
            <span class="brand-icon">☕</span>
            <span class="brand-name">Mocha Dreams</span>
            <span class="brand-tagline">Premium Coffee Experience</span>
        </div>
    </div>
</header>

<!-- Navigation Bar from Home Page -->
<nav class="main-nav">
    <div class="nav-container">

        <!-- Guest Navigation -->
        <div sec:authorize="!isAuthenticated()" class="nav-links">
            <a th:href="@{/auth/login}" class="nav-link">Login</a>
            <a th:href="@{/auth/register}" class="nav-link">Register</a>
        </div>

        <!-- Authenticated Navigation -->
        <div sec:authorize="isAuthenticated()" class="nav-links">
            <a th:href="@{/}" class="nav-link">Home</a>

            <a th:href="@{/cart/}" class="nav-link active">
                Cart
                <span class="cart-badge" th:text="${cartItemCount}">0</span>
            </a>

            <a th:href="@{/users/profile/}" class="nav-link">Profile</a>

            <a sec:authorize="hasRole('ADMIN')"
               th:href="@{/admin/dashboard}"
               class="nav-link admin-link">Dashboard</a>
        </div>

        <!-- Logout Button -->
        <div sec:authorize="isAuthenticated()" class="nav-logout">
            <form th:action="@{/auth/logout}" method="post" class="logout-form">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">
    <div class="container">

        <h1>Your Cart</h1>

        <!-- Empty cart -->
        <div th:if="${#lists.isEmpty(items)}" class="empty-cart">
            <p>Your cart is empty.</p>
        </div>

        <!-- Cart Items -->
        <!-- Контейнер для всех товаров -->
        <div class="cart-items-container">
            <div th:each="item : ${items}" class="cart-item">
                <div class="info">
                    <span th:text="${item.productName}">Product Name</span>
                </div>

                <div class="quantity">
                    Quantity: <span th:text="${item.quantity}">1</span>
                </div>

                <div class="price">
                    $<span th:text="${item.unitPrice}">0.00</span>
                </div>

                <div class="remove">
                    <form th:action="@{/cart/remove/{productId}(productId=${item.productId})}" method="post">
                        <button type="submit" class="remove-btn">Remove</button>
                    </form>
                </div>
            </div>
        </div>


        <!-- Total -->
        <div class="total">
            Total: $<span th:text="${total}">0.00</span>
        </div>

        <!-- Buttons -->
        <div class="buttons">
            <a th:href="@{/}"  class="btn">Continue Shopping</a>

            <form th:action="@{/cart/clear}" method="post" style="margin:0;">
                <button type="submit" class="btn">Clear Cart</button>
            </form>

            <form th:action="@{/orders/checkout}" method="post" style="margin:0;">
                <button type="submit" class="btn checkout-btn">Checkout</button>
            </form>
        </div>

    </div>
</main>

<!-- Footer optional -->
<footer class="site-footer">
    <div class="container">
        <p>&copy; 2025 Mocha Dreams. All rights reserved.</p>
    </div>
</footer>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {

        // Отслеживаем формы удаления товаров
        const removeForms = document.querySelectorAll('.cart-item .remove form');

        removeForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // предотвратить стандартную отправку формы

                const url = form.getAttribute('action');

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            // Удаляем карточку товара
                            form.closest('.cart-item').remove();

                            // Обновляем total
                            const totalEl = document.querySelector('.total span');
                            if(totalEl) totalEl.textContent = data.newTotal;

                            showNotification('Item removed from cart', 'success');

                            // Если корзина пустая, показываем сообщение
                            if(data.itemCount === 0) {
                                const emptyCart = document.createElement('div');
                                emptyCart.className = 'empty-cart';
                                emptyCart.innerHTML = '<p>Your cart is empty.</p>';
                                document.querySelector('.cart-items-container').appendChild(emptyCart);
                            }
                        } else {
                            showNotification('Error removing item', 'error');
                        }
                    })

                        .catch(err => {
                        console.error(err);
                        showNotification('Error removing item', 'error');
                    });
            });
        });

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    });
</script>

</body>
</html>
