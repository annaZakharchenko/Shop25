<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Mocha Dreams - Premium Coffee Shop</title>
    <link rel="stylesheet" th:href="@{/main.css}">
</head>
<body>

<!-- Header with Brand -->
<header class="site-header">
    <div class="brand-container">
        <div class="brand">
            <span class="brand-icon">☕</span>
            <span class="brand-name">Mocha Dreams</span>
            <span class="brand-tagline">Premium Coffee Experience</span>
        </div>
    </div>
</header>

<!-- Navigation Bar -->
<nav class="main-nav">
    <div class="nav-container">
        <!-- Guest Navigation -->
        <div sec:authorize="!isAuthenticated()" class="nav-links">
            <a th:href="@{/auth/login}" class="nav-link">
                <span class="icon"></span> Login
            </a>
            <a th:href="@{/auth/register}" class="nav-link">
                <span class="icon"></span> Register
            </a>
        </div>

        <!-- Authenticated User Navigation -->
        <div sec:authorize="isAuthenticated()" class="nav-links">
            <a th:href="@{/}" class="nav-link active">
                Home
            </a>
            <a th:href="@{/cart/}" class="nav-link">
                 Cart
                <span class="cart-badge" th:if="${cartItemCount > 0}" th:text="${cartItemCount}">0</span>
            </a>
            <a th:href="@{/users/profile/}" class="nav-link">
                 Profile
            </a>
            <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin/dashboard}" class="nav-link admin-link">
                 Dashboard
            </a>
        </div>

        <!-- Logout Button -->
        <div sec:authorize="isAuthenticated()" class="nav-logout">
            <form th:action="@{/auth/logout}" method="post" class="logout-form">
                <button type="submit" class="logout-btn">
                    Logout
                </button>
            </form>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">
    <div class="container">

        <!-- Admin Panel -->
        <section sec:authorize="hasRole('ADMIN')" class="admin-panel">
            <h2 class="section-title">
                 Admin Quick Actions
            </h2>
            <div class="admin-actions">
                <a th:href="@{/admin/products/create}" class="admin-btn">
                      Add Product
                </a>
                <a th:href="@{/admin/categories/create}" class="admin-btn">
                     Add Category
                </a>
                <a th:href="@{/orders/}" class="admin-btn">
                     View Orders
                </a>
            </div>
        </section>

        <!-- Category Filter -->
        <section class="category-section">
            <h2 class="section-title">
                Browse by Category
            </h2>
            <div class="category-filter">
                <a th:href="@{/}"
                   th:classappend="${category == null} ? 'active' : ''"
                   class="category-chip">
                    All Products
                </a>
                <a th:each="cat : ${categories}"
                   th:href="@{/?categoryId={id}(id=${cat.id})}"
                   th:text="${cat.name}"
                   th:classappend="${category != null and category.id == cat.id} ? 'active' : ''"
                   class="category-chip"></a>
            </div>
        </section>

        <!-- Products Section -->
        <section class="products-section">
            <h2 class="section-title">
                <span class="icon">☕</span> Our Premium Collection
            </h2>

            <!-- Empty State -->
            <div th:if="${#lists.isEmpty(products)}" class="empty-state">
                <h3>No products available</h3>
                <p>Check back soon for new arrivals!</p>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" th:unless="${#lists.isEmpty(products)}">
                <article th:each="product : ${products}" class="product-card">
                    <div class="product-image">
                        <img th:if="${product.imageUrl != null}"
                             th:src="${product.imageUrl}"
                             th:alt="${product.name}">
                        <img th:unless="${product.imageUrl != null}"
                             src="https://via.placeholder.com/300x300?text=No+Image"
                             alt="No image">
                        <div class="product-badge" th:if="${product.stock < 10 && product.stock > 0}">
                            Limited Stock
                        </div>
                        <div class="product-badge sold-out" th:if="${product.stock == 0}">
                            Sold Out
                        </div>
                    </div>

                    <div class="product-body">
                        <h3 class="product-name" th:text="${product.name}">Product Name</h3>
                        <p class="product-description"
                           th:if="${product.description != null}"
                           th:text="${#strings.abbreviate(product.description, 60)}">
                            Description
                        </p>

                        <div class="product-footer">
                            <div class="product-price" th:text="'$' + ${product.price}">$0.00</div>
                            <div class="product-stock" th:text="'Stock: ' + ${product.stock}">Stock: 0</div>
                        </div>

                        <div class="product-actions">

                            <!-- Details button for everyone -->
                            <a th:href="@{/products/detail/{id}(id=${product.id})}"
                               class="btn btn-secondary">
                                View Details
                            </a>

                            <!-- Button for authenticated users -->
                            <button class="btn btn-primary add-to-cart-btn"
                                    sec:authorize="isAuthenticated()"
                                    th:data-id="${product.id}"
                                    th:data-quantity="1"
                                    th:disabled="${product.stock == 0}">
                                Buy
                            </button>

                            <!-- Button for guests (shows login notification) -->
                            <button class="btn btn-primary guest-buy-btn"
                                    sec:authorize="!isAuthenticated()">
                                Buy
                            </button>
                        </div>


                    </div>
                </article>
            </div>
        </section>
    </div>
</main>

<!-- Footer -->
<footer class="site-footer">
    <div class="container">
        <p>&copy; 2025 Mocha Dreams. All rights reserved.</p>
        <p>Premium Coffee Experience, Delivered to Your Door</p>
    </div>
</footer>

<!-- JavaScript -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const addButtons = document.querySelectorAll('.add-to-cart-btn');

        addButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                if (btn.disabled) return;

                const productId = btn.getAttribute('data-id');
                const quantity = btn.getAttribute('data-quantity');

                btn.disabled = true;
                btn.textContent = 'Adding...';

                fetch('/cart/add-ajax/' + productId + '?quantity=' + quantity, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            const badge = document.querySelector('.cart-badge');
                            if (badge) {
                                badge.textContent = data.itemCount;
                            } else {
                                const cartLink = document.querySelector('a[href*="/cart"]');
                                if (cartLink) {
                                    const newBadge = document.createElement('span');
                                    newBadge.className = 'cart-badge';
                                    newBadge.textContent = data.itemCount;
                                    cartLink.appendChild(newBadge);
                                }
                            }

                            showNotification('Added to cart successfully!', 'success');
                            btn.disabled = false;
                            btn.innerHTML = 'Buy';
                        } else {
                            showNotification('Error adding to cart', 'error');
                            btn.disabled = false;
                            btn.innerHTML = 'Buy';
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showNotification('Error adding to cart', 'error');
                        btn.disabled = false;
                        btn.innerHTML = 'Buy';
                    });
            });
        });

        const guestButtons = document.querySelectorAll('.guest-buy-btn');
        guestButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                showNotification('Please login or create an account to buy products.', 'error');
            });
        });



        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }


    });
</script>

</body>
</html>